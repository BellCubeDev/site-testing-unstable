import { getInputValue } from '../../universal.js';
const api_baseUrl = `https://api.nexusmods.com/v1/games`;
window.statsScraper = {
    scrapeStats,
    setIDsFromURL
};
let cachedApiKey = null;
let willClearCache = false;
function getApiKey() {
    if (cachedApiKey)
        return cachedApiKey;
    cachedApiKey = getInputValue(document.getElementById('statsScraper_apiKey')) || null;
    if (!willClearCache) {
        willClearCache = true;
        requestAnimationFrame(() => requestAnimationFrame(() => {
            willClearCache = false;
            cachedApiKey = null;
        }));
    }
    return cachedApiKey;
}
function getApiRequestInit(apiKey, method = 'get') {
    if (!apiKey)
        apiKey = getApiKey();
    if (!apiKey)
        throw new Error('No API key provided!');
    const requestInit = {
        cache: 'no-cache',
        method,
        referrerPolicy: 'unsafe-url',
        credentials: 'omit',
        headers: {
            apiKey,
            accept: 'application/json',
            'user-agent': 'BellCubeDev/NexusMods-Mod-Stats-Scraper',
            origin: window.location.origin
        }
    };
    console.log('Returning request init:', requestInit);
    return requestInit;
}
async function setIDsFromURL(url) {
    if (!url)
        url = getInputValue(document.getElementById('statsScraper_extractURL'));
    const urlMatch = url.match(/.*?\bnexusmods\.com\/(\w+)\/mods\/(?:.*?\/)*?(\d+)\/?(\?.*|#.*|[^\w]*)$/);
    if (!urlMatch)
        throw new Error('Invalid URL');
    const modIDElem = document.getElementById('statsScraper_modID');
    const gameIDElem = document.getElementById('statsScraper_gameID');
    if (!modIDElem || !gameIDElem)
        throw new Error('Could not find modID or gameID input elements');
    const modID = parseInt(urlMatch[2] ?? '');
    const gameDomain = urlMatch[1] ?? '';
    const gameID = await fetch(`${api_baseUrl}/${gameDomain}.json`, getApiRequestInit())
        .then(r => r.json())
        .then(r => r.game_id);
    modIDElem.value = modID.toString();
    gameIDElem.value = gameID.toString();
}
async function scrapeStats() {
    const stats = parseStats(await fetchStats());
}
async function fetchStats() {
    const modID = parseInt(getInputValue(document.getElementById('statsScraper_modID')));
    const gameID = parseInt(getInputValue(document.getElementById('statsScraper_gameID')));
    const topLevel = await fetch(`${api_baseUrl}/${gameID}/mods/${modID}.json`, getApiRequestInit())
        .then(r => r.json());
    const endorsements_ = fetch(`https://nexus-stats.fra1.cdn.digitaloceanspaces.com/mods/${topLevel.uid}/daily-endorsements.json`, getApiRequestInit())
        .then(r => r.json());
    const dlAndViews_ = fetch(`https://staticstats.nexusmods.com/mod_monthly_stats/${topLevel.game_id}/${modID}.json`, getApiRequestInit())
        .then(r => r.json());
    const fileUploads_ = fetch(`https://www.nexusmods.com/Core/Libs/Common/Widgets/Graph?GetModReleases&game_id=${topLevel.game_id}&mod_id=${modID}&startdate=0&enddate=${Date.now()}`, getApiRequestInit())
        .then(r => r.json());
    const [endorsements, dlAndViews, fileUploads] = await Promise.all([endorsements_, dlAndViews_, fileUploads_]);
    console.debug('Fetched stats: ', { topLevel, endorsements, dlAndViews, fileUploads });
    return { topLevel, endorsements, dlAndViews, fileUploads };
}
function parseStats(stats) {
    function parseDate(str) {
        const firstTempDate = new Date(str);
        return new Date(firstTempDate.getFullYear(), firstTempDate.getMonth(), firstTempDate.getDate());
    }
    const mappedDateToData = {};
    for (const [date, endorsementCount] of Object.entries(stats.endorsements.endorsements)) {
        const __thisDate = parseDate(date);
        const thisDate = __thisDate.getTime();
        if (!mappedDateToData[thisDate])
            mappedDateToData[thisDate] = {};
        mappedDateToData[thisDate].endorsements = endorsementCount;
        mappedDateToData[thisDate].dateObj = __thisDate;
    }
    for (const [date, dlCount] of Object.entries(stats.dlAndViews.mod_daily_counts)) {
        const __thisDate = parseDate(date);
        const thisDate = __thisDate.getTime();
        if (!mappedDateToData[thisDate])
            mappedDateToData[thisDate] = {};
        mappedDateToData[thisDate].downloads = dlCount;
        mappedDateToData[thisDate].dateObj = __thisDate;
    }
    for (const [date, viewCount] of Object.entries(stats.dlAndViews.mod_page_views)) {
        const __thisDate = parseDate(date);
        const thisDate = __thisDate.getTime();
        if (!mappedDateToData[thisDate])
            mappedDateToData[thisDate] = {};
        mappedDateToData[thisDate].pageViews = viewCount;
        mappedDateToData[thisDate].dateObj = __thisDate;
    }
    const releases = {};
    for (const release of stats.fileUploads.message.releases) {
        const thisDate = parseDate(release.date * 1000).getTime();
        if (!releases[thisDate])
            releases[thisDate] = [];
        release.date = thisDate;
        releases[thisDate].push(release);
    }
    Object.fromEntries(Object.entries(releases).sort());
    console.debug('Fetched releases:', releases);
    for (const [date] of Object.entries(mappedDateToData)) {
        const thisDate = parseInt(date);
        const lastReleaseDate = parseInt(Object.keys(releases)
            .filter(releaseDate => parseInt(releaseDate) <= thisDate).sort().pop()
            ?? '-1');
        const diffDays = lastReleaseDate === -1 ? null : Math.round((thisDate - lastReleaseDate) / (1000 * 60 * 60 * 24));
        mappedDateToData[thisDate].daysSinceLastUpload = diffDays;
    }
    return Object.values(mappedDateToData);
}
async function createFileTrees(topLevel, files) {
    let hasFinishedFiles = false;
    const fileTrees = [];
    const fileTreesByID = {};
    let filesById;
    const fileIDs = files.map(file => file.id[0]);
    const filesFetched = {};
    fileIDs.forEach(id => filesFetched[id] = false);
    const hiddenFiles = [];
    const canonicalFiles = await (await fetch(`${api_baseUrl}/${topLevel.domain_name}/mods/${topLevel.mod_id}/files.json`, getApiRequestInit())).json();
    canonicalFiles.files.forEach(file => filesById[file.id[0]] = file);
    console.debug('Fetched files from API:', canonicalFiles);
    for (const fileID of fileIDs) {
        if (filesFetched[fileID])
            continue;
        console.debug(`Fetching file ${fileID} separately...`);
        fetch(`${api_baseUrl}/${topLevel.domain_name}/mods/${topLevel.mod_id}/files/${fileID}.json`, getApiRequestInit())
            .then(async (fileData) => {
            hiddenFiles.push(await fileData.json());
            filesFetched[fileID] = true;
            finishFiles();
        });
    }
    finishFiles();
    async function finishFiles() {
        if (hasFinishedFiles || Object.values(filesFetched).includes(false))
            return;
        hasFinishedFiles = true;
        console.debug('Finished fetching files');
        console.debug('Files: ', [...canonicalFiles.files, ...hiddenFiles]);
        console.debug('Updates: ', canonicalFiles.file_updates);
        processFiles([...canonicalFiles.files, ...hiddenFiles], canonicalFiles.file_updates);
    }
    function processFiles(files, updates) {
        filesById = Object.fromEntries(files.map(file => [file.file_id, file]));
        for (const update of updates) {
            addUpdate(update);
        }
        console.debug('File Trees:', fileTrees);
        console.debug('File Trees by ID:', fileTreesByID);
    }
    function addUpdate(update) {
        const oldFile = filesById[update.old_file_id];
        if (!oldFile)
            throw new Error(`Could not find OLD file ${update.old_file_id} for update\n${JSON.stringify(update, undefined, 4)}`);
        const newFile = filesById[update.new_file_id];
        if (!newFile)
            throw new Error(`Could not find NEW file ${update.new_file_id} for update\n${JSON.stringify(update, undefined, 4)}`);
        const oldFileTree = fileTreesByID[oldFile.file_id] ?? { fileInfo: oldFile, oldFile: null };
        removeOldFileTree(update);
        const newFileTree = { fileInfo: newFile, oldFile: oldFileTree };
        fileTrees.push(newFileTree);
        fileTreesByID[newFile.file_id] = newFileTree;
    }
    function removeOldFileTree(update) {
        const oldFile = filesById[update.old_file_id];
        if (!oldFile)
            throw new Error(`Could not find OLD file ${update.old_file_id} for update\n${JSON.stringify(update, undefined, 4)}`);
        const oldFileTree = fileTreesByID[oldFile.file_id] ?? { fileInfo: oldFile, oldFile: null };
        const oldFileTreeIndex = fileTrees.indexOf(oldFileTree);
        console.log(oldFileTreeIndex);
        if (oldFileTreeIndex < 0)
            return;
        fileTrees.splice(oldFileTreeIndex, 1);
        removeOldFileTree(update);
    }
}
const csvHeader = 'Date\tDownloads\tPage Views\tEndorsements\tDays Since Last Upload';
function getArrayOfDataData(mappedDateToData) {
    return new Map(Object.entries(mappedDateToData).sort((a, b) => -((a[1]?.dateObj?.getTime() ?? 0) - (b[1]?.dateObj?.getTime() ?? 0))));
}
function getCSV(mappedDateToData) {
    const dataSortedByDescendingDate = getArrayOfDataData(mappedDateToData);
    const csvData = [...dataSortedByDescendingDate]
        .map(([, thisDateData]) => `${thisDateData.dateObj?.toLocaleDateString()}\t${thisDateData.downloads ?? 0}\t${thisDateData.pageViews ?? 0}\t${thisDateData.endorsements ?? 0}\t${thisDateData.daysSinceLastUpload ?? 'No Upload Yet'}`);
    console.debug('CSV data:', csvData);
    return csvData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV4dXMtc3RhdHMtc2NyYXBlci5qcyIsInNvdXJjZVJvb3QiOiJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vQmVsbEN1YmVEZXYvc2l0ZS10ZXN0aW5nL2RlcGxveW1lbnQvIiwic291cmNlcyI6WyJ0b29scy9uZXh1cy1zdGF0cy1zY3JhcGVyL25leHVzLXN0YXRzLXNjcmFwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRW5ELE1BQU0sV0FBVyxHQUFHLG9DQUFvQyxDQUFDO0FBU3pELE1BQU0sQ0FBQyxZQUFZLEdBQUc7SUFDbEIsV0FBVztJQUNYLGFBQWE7Q0FDaEIsQ0FBQztBQUtGLElBQUksWUFBWSxHQUFlLElBQUksQ0FBQztBQUNwQyxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUM7QUFDM0IsU0FBUyxTQUFTO0lBQ2QsSUFBSSxZQUFZO1FBQUUsT0FBTyxZQUFZLENBQUM7SUFFdEMsWUFBWSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLHFCQUFxQixDQUFxQixDQUFDLElBQUksSUFBSSxDQUFDO0lBRXpHLElBQUksQ0FBQyxjQUFjLEVBQUM7UUFDaEIsY0FBYyxHQUFHLElBQUksQ0FBQztRQUN0QixxQkFBcUIsQ0FBQyxHQUFFLEVBQUUsQ0FBQSxxQkFBcUIsQ0FBQyxHQUFHLEVBQUU7WUFDakQsY0FBYyxHQUFHLEtBQUssQ0FBQztZQUN2QixZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDUDtJQUVELE9BQU8sWUFBWSxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLE1BQW9CLEVBQUUsU0FBaUIsS0FBSztJQUNuRSxJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sR0FBRyxTQUFTLEVBQUUsQ0FBQztJQUNsQyxJQUFJLENBQUMsTUFBTTtRQUFFLE1BQU0sSUFBSSxLQUFLLENB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IjpbImltcG9ydCB0eXBlICogYXMgcmF3SW5mbyBmcm9tICcuL25leHVzTW9kc0luZm8nO1xuaW1wb3J0IHsgZ2V0SW5wdXRWYWx1ZSB9IGZyb20gJy4uLy4uL3VuaXZlcnNhbC5qcyc7XG5cbmNvbnN0IGFwaV9iYXNlVXJsID0gYGh0dHBzOi8vYXBpLm5leHVzbW9kcy5jb20vdjEvZ2FtZXNgO1xuXG5kZWNsYXJlIGdsb2JhbCB7aW50ZXJmYWNlIFdpbmRvdyB7XG4gICAgc3RhdHNTY3JhcGVyOiB7XG4gICAgICAgIHNjcmFwZVN0YXRzOiAoKSA9PiB2b2lkO1xuICAgICAgICBzZXRJRHNGcm9tVVJMOiAoKSA9PiB2b2lkO1xuICAgIH1cbn19XG5cbndpbmRvdy5zdGF0c1NjcmFwZXIgPSB7XG4gICAgc2NyYXBlU3RhdHMsXG4gICAgc2V0SURzRnJvbVVSTFxufTtcblxuLy8gQ3JlYXRlIGRlYnVnIGRpcmVjdG9yaWVzIGFuZCBzYXZlIGVudmlyb25tZW50XG5cblxubGV0IGNhY2hlZEFwaUtleTpudWxsfHN0cmluZyA9IG51bGw7XG5sZXQgd2lsbENsZWFyQ2FjaGUgPSBmYWxzZTtcbmZ1bmN0aW9uIGdldEFwaUtleSgpIDogc3RyaW5nfG51bGwge1xuICAgIGlmIChjYWNoZWRBcGlLZXkpIHJldHVybiBjYWNoZWRBcGlLZXk7XG5cbiAgICBjYWNoZWRBcGlLZXkgPSBnZXRJbnB1dFZhbHVlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0c1NjcmFwZXJfYXBpS2V5JykgYXMgSFRNTElucHV0RWxlbWVudCkgfHwgbnVsbDtcblxuICAgIGlmICghd2lsbENsZWFyQ2FjaGUpe1xuICAgICAgICB3aWxsQ2xlYXJDYWNoZSA9IHRydWU7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKT0+cmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+e1xuICAgICAgICAgICAgd2lsbENsZWFyQ2FjaGUgPSBmYWxzZTtcbiAgICAgICAgICAgIGNhY2hlZEFwaUtleSA9IG51bGw7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FjaGVkQXBpS2V5O1xufVxuXG5mdW5jdGlvbiBnZXRBcGlSZXF1ZXN0SW5pdChhcGlLZXk/OiBzdHJpbmd8bnVsbCwgbWV0aG9kOiBzdHJpbmcgPSAnZ2V0JykgOiBSZXF1ZXN0SW5pdCB7XG4gICAgaWYgKCFhcGlLZXkpIGFwaUtleSA9IGdldEFwaUtleSgpO1xuICAgIGlmICghYXBpS2V5KSB0aHJvdyBuZXcgRXJyb3IoJ05vIEFQSSBrZXkgcHJvdmlkZWQhJyk7XG5cblxuICAgIGNvbnN0IHJlcXVlc3RJbml0OlJlcXVlc3RJbml0ID0ge1xuICAgICAgICBjYWNoZTonbm8tY2FjaGUnLFxuICAgICAgICBtZXRob2QsXG4gICAgICAgIHJlZmVycmVyUG9saWN5OiAndW5zYWZlLXVybCcsXG4gICAgICAgIGNyZWRlbnRpYWxzOiAnb21pdCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIGFwaUtleSxcbiAgICAgICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiAnQmVsbEN1YmVEZXYvTmV4dXNNb2RzLU1vZC1TdGF0cy1TY3JhcGVyJyxcbiAgICAgICAgICAgIG9yaWdpbjogd2luZG93LmxvY2F0aW9uLm9yaWdpblxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnNvbGUubG9nKCdSZXR1cm5pbmcgcmVxdWVzdCBpbml0OicsIHJlcXVlc3RJbml0KTtcblxuICAgIHJldHVybiByZXF1ZXN0SW5pdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0SURzRnJvbVVSTCh1cmw/OiBzdHJpbmcpIHtcbiAgICBpZiAoIXVybCkgdXJsID0gZ2V0SW5wdXRWYWx1ZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHNTY3JhcGVyX2V4dHJhY3RVUkwnKSBhcyBIVE1MSW5wdXRFbGVtZW50KTtcblxuICAgIGNvbnN0IHVybE1hdGNoID0gdXJsLm1hdGNoKC8uKj9cXGJuZXh1c21vZHNcXC5jb21cXC8oXFx3KylcXC9tb2RzXFwvKD86Lio/XFwvKSo/KFxcZCspXFwvPyhcXD8uKnwjLip8W15cXHddKikkLyk7XG4gICAgaWYgKCF1cmxNYXRjaCkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFVSTCcpO1xuXG4gICAgY29uc3QgbW9kSURFbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRzU2NyYXBlcl9tb2RJRCcpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgY29uc3QgZ2FtZUlERWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0c1NjcmFwZXJfZ2FtZUlEJykgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICBpZiAoIW1vZElERWxlbSB8fCAhZ2FtZUlERWxlbSkgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBtb2RJRCBvciBnYW1lSUQgaW5wdXQgZWxlbWVudHMnKTtcblxuICAgIGNvbnN0IG1vZElEID0gcGFyc2VJbnQodXJsTWF0Y2hbMl0gPz8gJycpO1xuXG4gICAgY29uc3QgZ2FtZURvbWFpbiA9IHVybE1hdGNoWzFdID8/ICcnO1xuICAgIGNvbnN0IGdhbWVJRCA9IGF3YWl0IGZldGNoKGAke2FwaV9iYXNlVXJsfS8ke2dhbWVEb21haW59Lmpzb25gLCBnZXRBcGlSZXF1ZXN0SW5pdCgpKVxuICAgICAgICAudGhlbihyID0+IHIuanNvbigpIGFzIFByb21pc2U8e2dhbWVfaWQ6IG51bWJlcn0+KVxuICAgICAgICAudGhlbihyID0+IHIuZ2FtZV9pZCk7XG5cbiAgICBtb2RJREVsZW0udmFsdWUgPSBtb2RJRC50b1N0cmluZygpO1xuICAgIGdhbWVJREVsZW0udmFsdWUgPSBnYW1lSUQudG9TdHJpbmcoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2NyYXBlU3RhdHMoKSB7XG4gICAgY29uc3Qgc3RhdHMgPSBwYXJzZVN0YXRzKGF3YWl0IGZldGNoU3RhdHMoKSk7XG5cbn1cblxuXG4vKiogUGFyc2VkIGRhdGUgZGF0YSAqL1xuaW50ZXJmYWNlIElEYXRlRGF0YSB7XG4gICAgZGF0ZU9iaj86IERhdGU7XG4gICAgcGFnZVZpZXdzPzogbnVtYmVyO1xuICAgIGRvd25sb2Fkcz86IG51bWJlcjtcbiAgICBlbmRvcnNlbWVudHM/OiBudW1iZXI7XG4gICAgZGF5c1NpbmNlTGFzdFVwbG9hZD86IG51bWJlciB8IG51bGw7XG59XG5cbi8qKipcbiAqXG4gKlxuICogICAgJCQkJCQkJCRcXCAgICAgICAgICAgICAkJFxcICAgICAgICAgICAgICAgJCRcXFxuICogICAgJCQgIF9fX19ffCAgICAgICAgICAgICQkIHwgICAgICAgICAgICAgICQkIHxcbiAqICAgICQkIHwgICAgICAgJCQkJCQkXFwgICQkJCQkJFxcICAgICQkJCQkJCRcXCAkJCQkJCQkXFwgICAkJCQkJCRcXCAgICQkJCQkJCRcXFxuICogICAgJCQkJCRcXCAgICAkJCAgX18kJFxcIFxcXyQkICBffCAgJCQgIF9fX19ffCQkICBfXyQkXFwgJCQgIF9fJCRcXCAkJCAgX19fX198XG4gKiAgICAkJCAgX198ICAgJCQkJCQkJCQgfCAgJCQgfCAgICAkJCAvICAgICAgJCQgfCAgJCQgfCQkJCQkJCQkIHxcXCQkJCQkJFxcXG4gKiAgICAkJCB8ICAgICAgJCQgICBfX19ffCAgJCQgfCQkXFwgJCQgfCAgICAgICQkIHwgICQkIHwkJCAgIF9fX198IFxcX19fXyQkXFxcbiAqICAgICQkIHwgICAgICBcXCQkJCQkJCRcXCAgIFxcJCQkJCAgfFxcJCQkJCQkJFxcICQkIHwgICQkIHxcXCQkJCQkJCRcXCAkJCQkJCQkICB8XG4gKiAgICBcXF9ffCAgICAgICBcXF9fX19fX198ICAgXFxfX19fLyAgXFxfX19fX19ffFxcX198ICBcXF9ffCBcXF9fX19fX198XFxfX19fX19fL1xuICpcbiAqL1xuXG5pbnRlcmZhY2Ugc3RhdHNJdGVtcyB7XG4gICAgdG9wTGV2ZWw6IHJhd0luZm8uSU1vZFxuICAgIGVuZG9yc2VtZW50czogcmF3SW5mby5JRW5kb3JzZW1lbnRzXG4gICAgZGxBbmRWaWV3czogcmF3SW5mby5JRExzQW5kVmlld3NcbiAgICBmaWxlVXBsb2FkczogcmF3SW5mby5JRmlsZVVwbG9hZHNcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hTdGF0cygpOlByb21pc2U8c3RhdHNJdGVtcz4ge1xuICAgIGNvbnN0IG1vZElEID0gcGFyc2VJbnQoZ2V0SW5wdXRWYWx1ZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHNTY3JhcGVyX21vZElEJykgYXMgSFRNTElucHV0RWxlbWVudCkpO1xuICAgIGNvbnN0IGdhbWVJRCA9IHBhcnNlSW50KGdldElucHV0VmFsdWUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRzU2NyYXBlcl9nYW1lSUQnKSBhcyBIVE1MSW5wdXRFbGVtZW50KSk7XG5cbiAgICBjb25zdCB0b3BMZXZlbCA9IGF3YWl0IGZldGNoKGAke2FwaV9iYXNlVXJsfS8ke2dhbWVJRH0vbW9kcy8ke21vZElEfS5qc29uYCwgZ2V0QXBpUmVxdWVzdEluaXQoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ociA9PiByLmpzb24oKSkgYXMgcmF3SW5mby5JTW9kO1xuXG4gICAgLy8gR2V0IEVuZG9yc2VtZW50cywgRG93bmxvYWRzLCBQYWdlIFZpZXdzLCBhbmQgVXBsb2FkcyBkYXRhIGFsbCBpbiBvbmUgZ28gdGhhbmtzIHRvIHRoZSBwb3dlciBvZiBQcm9taXNlLmFsbFxuICAgIGNvbnN0IGVuZG9yc2VtZW50c18gPSBmZXRjaChgaHR0cHM6Ly9uZXh1cy1zdGF0cy5mcmExLmNkbi5kaWdpdGFsb2NlYW5zcGFjZXMuY29tL21vZHMvJHt0b3BMZXZlbC51aWR9L2RhaWx5LWVuZG9yc2VtZW50cy5qc29uYCwgZ2V0QXBpUmVxdWVzdEluaXQoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyID0+IHIuanNvbigpIGFzIFByb21pc2U8cmF3SW5mby5JRW5kb3JzZW1lbnRzPik7XG4gICAgY29uc3QgZGxBbmRWaWV3c18gICA9IGZldGNoKGBodHRwczovL3N0YXRpY3N0YXRzLm5leHVzbW9kcy5jb20vbW9kX21vbnRobHlfc3RhdHMvJHt0b3BMZXZlbC5nYW1lX2lkfS8ke21vZElEfS5qc29uYCwgZ2V0QXBpUmVxdWVzdEluaXQoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyID0+IHIuanNvbigpICBhcyBQcm9taXNlPHJhd0luZm8uSURMc0FuZFZpZXdzPik7XG4gICAgY29uc3QgZmlsZVVwbG9hZHNfICA9IGZldGNoKGBodHRwczovL3d3dy5uZXh1c21vZHMuY29tL0NvcmUvTGlicy9Db21tb24vV2lkZ2V0cy9HcmFwaD9HZXRNb2RSZWxlYXNlcyZnYW1lX2lkPSR7dG9wTGV2ZWwuZ2FtZV9pZH0mbW9kX2lkPSR7bW9kSUR9JnN0YXJ0ZGF0ZT0wJmVuZGRhdGU9JHtEYXRlLm5vdygpfWAsIGdldEFwaVJlcXVlc3RJbml0KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ociA9PiByLmpzb24oKSBhcyBQcm9taXNlPHJhd0luZm8uSUZpbGVVcGxvYWRzPik7XG5cbiAgICBjb25zdCBbZW5kb3JzZW1lbnRzLCBkbEFuZFZpZXdzLCBmaWxlVXBsb2Fkc10gPSBhd2FpdCBQcm9taXNlLmFsbChbZW5kb3JzZW1lbnRzXywgZGxBbmRWaWV3c18sIGZpbGVVcGxvYWRzX10pO1xuXG4gICAgY29uc29sZS5kZWJ1ZygnRmV0Y2hlZCBzdGF0czogJywge3RvcExldmVsLCBlbmRvcnNlbWVudHMsIGRsQW5kVmlld3MsIGZpbGVVcGxvYWRzfSk7XG4gICAgcmV0dXJuIHt0b3BMZXZlbCwgZW5kb3JzZW1lbnRzLCBkbEFuZFZpZXdzLCBmaWxlVXBsb2Fkc307XG59XG5cblxuLypcbiAqXG4gKlxuICogICAgJCQkJCQkJFxcICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJFxcXG4gKiAgICAkJCAgX18kJFxcICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcX198XG4gKiAgICAkJCB8ICAkJCB8ICQkJCQkJFxcICAgJCQkJCQkXFwgICAkJCQkJCQkXFwgJCRcXCAkJCQkJCQkXFwgICAkJCQkJCRcXFxuICogICAgJCQkJCQkJCAgfCBcXF9fX18kJFxcICQkICBfXyQkXFwgJCQgIF9fX19ffCQkIHwkJCAgX18kJFxcICQkICBfXyQkXFxcbiAqICAgICQkICBfX19fLyAgJCQkJCQkJCB8JCQgfCAgXFxfX3xcXCQkJCQkJFxcICAkJCB8JCQgfCAgJCQgfCQkIC8gICQkIHxcbiAqICAgICQkIHwgICAgICAkJCAgX18kJCB8JCQgfCAgICAgICBcXF9fX18kJFxcICQkIHwkJCB8ICAkJCB8JCQgfCAgJCQgfFxuICogICAgJCQgfCAgICAgIFxcJCQkJCQkJCB8JCQgfCAgICAgICQkJCQkJCQgIHwkJCB8JCQgfCAgJCQgfFxcJCQkJCQkJCB8XG4gKiAgICBcXF9ffCAgICAgICBcXF9fX19fX198XFxfX3wgICAgICBcXF9fX19fX18vIFxcX198XFxfX3wgIFxcX198IFxcX19fXyQkIHxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkXFwgICAkJCB8XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXCQkJCQkJCAgfFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcX19fX19fL1xuICovXG5cbnR5cGUgSU1vZFN0YXRzID0gUmVjb3JkPG51bWJlciwgSURhdGVEYXRhPlxuXG5mdW5jdGlvbiBwYXJzZVN0YXRzKHN0YXRzOnN0YXRzSXRlbXMpOklEYXRlRGF0YVtdIHtcblxuICAgIC8qKiBSZXR1cm5zIHRoZSBwYXNzZWQtaW4sIGRpc3RpbGxlZCBkb3duIHRvIHRoZSBkYXkgKi9cbiAgICBmdW5jdGlvbiBwYXJzZURhdGUoc3RyOm51bWJlcnxzdHJpbmd8RGF0ZSk6RGF0ZSB7XG4gICAgICAgIGNvbnN0IGZpcnN0VGVtcERhdGUgPSBuZXcgRGF0ZShzdHIpO1xuICAgICAgICByZXR1cm4gbmV3IERhdGUoZmlyc3RUZW1wRGF0ZS5nZXRGdWxsWWVhcigpLCBmaXJzdFRlbXBEYXRlLmdldE1vbnRoKCksIGZpcnN0VGVtcERhdGUuZ2V0RGF0ZSgpKTtcbiAgICB9XG5cbiAgICBjb25zdCBtYXBwZWREYXRlVG9EYXRhOiBSZWNvcmQ8bnVtYmVyLCBJRGF0ZURhdGE+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IFtkYXRlLCBlbmRvcnNlbWVudENvdW50XSBvZiBPYmplY3QuZW50cmllcyhzdGF0cy5lbmRvcnNlbWVudHMuZW5kb3JzZW1lbnRzKSkge1xuICAgICAgICBjb25zdCBfX3RoaXNEYXRlID0gcGFyc2VEYXRlKGRhdGUpO1xuICAgICAgICBjb25zdCB0aGlzRGF0ZSA9IF9fdGhpc0RhdGUuZ2V0VGltZSgpO1xuXG4gICAgICAgIGlmICghbWFwcGVkRGF0ZVRvRGF0YVt0aGlzRGF0ZV0pIG1hcHBlZERhdGVUb0RhdGFbdGhpc0RhdGVdID0ge307XG5cbiAgICAgICAgbWFwcGVkRGF0ZVRvRGF0YVt0aGlzRGF0ZV0hLmVuZG9yc2VtZW50cyA9IGVuZG9yc2VtZW50Q291bnQ7XG4gICAgICAgIG1hcHBlZERhdGVUb0RhdGFbdGhpc0RhdGVdIS5kYXRlT2JqID0gX190aGlzRGF0ZTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IFtkYXRlLCBkbENvdW50XSBvZiBPYmplY3QuZW50cmllcyhzdGF0cy5kbEFuZFZpZXdzLm1vZF9kYWlseV9jb3VudHMpKSB7XG4gICAgICAgIGNvbnN0IF9fdGhpc0RhdGUgPSBwYXJzZURhdGUoZGF0ZSk7XG4gICAgICAgIGNvbnN0IHRoaXNEYXRlID0gX190aGlzRGF0ZS5nZXRUaW1lKCk7XG5cbiAgICAgICAgaWYgKCFtYXBwZWREYXRlVG9EYXRhW3RoaXNEYXRlXSkgbWFwcGVkRGF0ZVRvRGF0YVt0aGlzRGF0ZV0gPSB7fTtcblxuICAgICAgICBtYXBwZWREYXRlVG9EYXRhW3RoaXNEYXRlXSEuZG93bmxvYWRzID0gZGxDb3VudDtcbiAgICAgICAgbWFwcGVkRGF0ZVRvRGF0YVt0aGlzRGF0ZV0hLmRhdGVPYmogPSBfX3RoaXNEYXRlO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgW2RhdGUsIHZpZXdDb3VudF0gb2YgT2JqZWN0LmVudHJpZXMoc3RhdHMuZGxBbmRWaWV3cy5tb2RfcGFnZV92aWV3cykpIHtcbiAgICAgICAgY29uc3QgX190aGlzRGF0ZSA9IHBhcnNlRGF0ZShkYXRlKTtcbiAgICAgICAgY29uc3QgdGhpc0RhdGUgPSBfX3RoaXNEYXRlLmdldFRpbWUoKTtcblxuICAgICAgICBpZiAoIW1hcHBlZERhdGVUb0RhdGFbdGhpc0RhdGVdKSBtYXBwZWREYXRlVG9EYXRhW3RoaXNEYXRlXSA9IHt9O1xuXG4gICAgICAgIG1hcHBlZERhdGVUb0RhdGFbdGhpc0RhdGVdIS5wYWdlVmlld3MgPSB2aWV3Q291bnQ7XG4gICAgICAgIG1hcHBlZERhdGVUb0RhdGFbdGhpc0RhdGVdIS5kYXRlT2JqID0gX190aGlzRGF0ZTtcbiAgICB9XG5cbiAgICBjb25zdCByZWxlYXNlczogUmVjb3JkPG51bWJlciwgcmF3SW5mby5JU2luZ2xlVXBsb2FkW10+ID0ge307XG4gICAgZm9yIChjb25zdCByZWxlYXNlIG9mIHN0YXRzLmZpbGVVcGxvYWRzLm1lc3NhZ2UucmVsZWFzZXMpIHtcbiAgICAgICAgY29uc3QgdGhpc0RhdGUgPSBwYXJzZURhdGUocmVsZWFzZS5kYXRlICogMTAwMCkuZ2V0VGltZSgpO1xuXG4gICAgICAgIGlmICghcmVsZWFzZXNbdGhpc0RhdGVdKSByZWxlYXNlc1t0aGlzRGF0ZV0gPSBbXTtcblxuICAgICAgICByZWxlYXNlLmRhdGUgPSB0aGlzRGF0ZTtcbiAgICAgICAgcmVsZWFzZXNbdGhpc0RhdGVdIS5wdXNoKHJlbGVhc2UpO1xuICAgIH1cbiAgICBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocmVsZWFzZXMpLnNvcnQoKSk7XG5cbiAgICBjb25zb2xlLmRlYnVnKCdGZXRjaGVkIHJlbGVhc2VzOicsIHJlbGVhc2VzKTtcblxuICAgIGZvciAoY29uc3QgW2RhdGVdIG9mIE9iamVjdC5lbnRyaWVzKG1hcHBlZERhdGVUb0RhdGEpKSB7XG5cbiAgICAgICAgY29uc3QgdGhpc0RhdGUgPSBwYXJzZUludChkYXRlKTtcblxuICAgICAgICBjb25zdCBsYXN0UmVsZWFzZURhdGUgPSBwYXJzZUludChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocmVsZWFzZXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIocmVsZWFzZURhdGUgPT4gcGFyc2VJbnQocmVsZWFzZURhdGUpIDw9IHRoaXNEYXRlKS5zb3J0KCkucG9wKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/PyAnLTEnICk7XG5cbiAgICAgICAgY29uc3QgZGlmZkRheXMgPSBsYXN0UmVsZWFzZURhdGUgPT09IC0xID8gbnVsbCA6IE1hdGgucm91bmQoKHRoaXNEYXRlIC0gbGFzdFJlbGVhc2VEYXRlKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7XG5cbiAgICAgICAgbWFwcGVkRGF0ZVRvRGF0YVt0aGlzRGF0ZV0hLmRheXNTaW5jZUxhc3RVcGxvYWQgPSBkaWZmRGF5cztcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhtYXBwZWREYXRlVG9EYXRhKTtcbn1cblxuLypcbiAqICAgICQkJCQkJCQkXFwgJCRcXCAkJFxcICAgICAgICAgICAgICAgICAkJCQkJCQkJFxcXG4gKiAgICAkJCAgX19fX198XFxfX3wkJCB8ICAgICAgICAgICAgICAgIFxcX18kJCAgX198XG4gKiAgICAkJCB8ICAgICAgJCRcXCAkJCB8ICQkJCQkJFxcICAgICAgICAgICAkJCB8ICAgICQkJCQkJFxcICAgJCQkJCQkXFwgICAkJCQkJCRcXCAgICQkJCQkJCRcXFxuICogICAgJCQkJCRcXCAgICAkJCB8JCQgfCQkICBfXyQkXFwgICAgICAgICAgJCQgfCAgICQkICBfXyQkXFwgJCQgIF9fJCRcXCAkJCAgX18kJFxcICQkICBfX19fX3xcbiAqICAgICQkICBfX3wgICAkJCB8JCQgfCQkJCQkJCQkIHwgICAgICAgICAkJCB8ICAgJCQgfCAgXFxfX3wkJCQkJCQkJCB8JCQkJCQkJCQgfFxcJCQkJCQkXFxcbiAqICAgICQkIHwgICAgICAkJCB8JCQgfCQkICAgX19fX3wgICAgICAgICAkJCB8ICAgJCQgfCAgICAgICQkICAgX19fX3wkJCAgIF9fX198IFxcX19fXyQkXFxcbiAqICAgICQkIHwgICAgICAkJCB8JCQgfFxcJCQkJCQkJFxcICAgICAgICAgICQkIHwgICAkJCB8ICAgICAgXFwkJCQkJCQkXFwgXFwkJCQkJCQkXFwgJCQkJCQkJCAgfFxuICogICAgXFxfX3wgICAgICBcXF9ffFxcX198IFxcX19fX19fX3wgICAgICAgICBcXF9ffCAgIFxcX198ICAgICAgIFxcX19fX19fX3wgXFxfX19fX19ffFxcX19fX19fXy9cbiAqXG4gKlxuICpcbiAqL1xuXG5cbmludGVyZmFjZSBJVXBkYXRlZEZpbGUge1xuICAgIGZpbGVJbmZvOiByYXdJbmZvLklGaWxlO1xuICAgIG9sZEZpbGU6IElVcGRhdGVkRmlsZXxudWxsO1xufVxuXG5pbnRlcmZhY2UgSUZpbGVUcmVlcyB7XG4gICAgZmlsZVRyZWVzOiBJVXBkYXRlZEZpbGVbXTtcbiAgICBmaWxlVHJlZXNCeUlEOiBSZWNvcmQ8bnVtYmVyLCBJVXBkYXRlZEZpbGU+O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGaWxlVHJlZXModG9wTGV2ZWw6IHJhd0luZm8uSU1vZCwgZmlsZXM6IHJhd0luZm8uSUZpbGVbXSkge1xuICAgIGxldCBoYXNGaW5pc2hlZEZpbGVzID0gZmFsc2U7XG5cbiAgICBjb25zdCBmaWxlVHJlZXM6SVVwZGF0ZWRGaWxlW10gPSBbXTtcbiAgICBjb25zdCBmaWxlVHJlZXNCeUlEOlJlY29yZDxzdHJpbmcsIElVcGRhdGVkRmlsZT4gPSB7fTtcbiAgICBsZXQgZmlsZXNCeUlkOiBSZWNvcmQ8c3RyaW5nLCByYXdJbmZvLklGaWxlPjtcblxuICAgIGNvbnN0IGZpbGVJRHMgPSBmaWxlcy5tYXAoZmlsZSA9PiBmaWxlLmlkWzBdKTtcblxuICAgIGNvbnN0IGZpbGVzRmV0Y2hlZDpSZWNvcmQ8bnVtYmVyLCBib29sZWFuPiA9IHt9O1xuICAgIGZpbGVJRHMuZm9yRWFjaChpZD0+IGZpbGVzRmV0Y2hlZFtpZF0gPSBmYWxzZSApO1xuXG5cbiAgICAvLyBMaXN0IG9mIHJhdyBmaWxlc1xuICAgIGNvbnN0IGhpZGRlbkZpbGVzOiByYXdJbmZvLklGaWxlW10gPSBbXTtcblxuICAgIC8vIEdldCB0aGUgZmlsZXMgYXZhaWxhYmxlIHRvIHRoZSBBUEkgZGlyZWN0bHk6XG4gICAgY29uc3QgY2Fub25pY2FsRmlsZXMgPSBhd2FpdCAoYXdhaXQgZmV0Y2goYCR7YXBpX2Jhc2VVcmx9LyR7dG9wTGV2ZWwuZG9tYWluX25hbWV9L21vZHMvJHt0b3BMZXZlbC5tb2RfaWR9L2ZpbGVzLmpzb25gLCBnZXRBcGlSZXF1ZXN0SW5pdCgpKSkuanNvbigpIGFzIHJhd0luZm8uSUZpbGVMaXN0O1xuICAgIGNhbm9uaWNhbEZpbGVzLmZpbGVzLmZvckVhY2goZmlsZSA9PiBmaWxlc0J5SWRbZmlsZS5pZFswXV0gPSBmaWxlKTtcblxuICAgIGNvbnNvbGUuZGVidWcoJ0ZldGNoZWQgZmlsZXMgZnJvbSBBUEk6JywgY2Fub25pY2FsRmlsZXMpO1xuXG4gICAgLy8gR2V0IGZpbGVzIHRoYXQgaGF2ZSBiZWVuIGhpZGRlbiBmcm9tIHRoZSBBUEk6XG4gICAgZm9yIChjb25zdCBmaWxlSUQgb2YgZmlsZUlEcykge1xuICAgICAgICBpZiAoZmlsZXNGZXRjaGVkW2ZpbGVJRF0pIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnNvbGUuZGVidWcoYEZldGNoaW5nIGZpbGUgJHtmaWxlSUR9IHNlcGFyYXRlbHkuLi5gKTtcblxuICAgICAgICBmZXRjaChgJHthcGlfYmFzZVVybH0vJHt0b3BMZXZlbC5kb21haW5fbmFtZX0vbW9kcy8ke3RvcExldmVsLm1vZF9pZH0vZmlsZXMvJHtmaWxlSUR9Lmpzb25gLCBnZXRBcGlSZXF1ZXN0SW5pdCgpKVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgKGZpbGVEYXRhKSA9PiB7XG5cbiAgICAgICAgICAgIGhpZGRlbkZpbGVzLnB1c2goYXdhaXQgZmlsZURhdGEuanNvbigpKTtcbiAgICAgICAgICAgIGZpbGVzRmV0Y2hlZFtmaWxlSURdID0gdHJ1ZTtcblxuICAgICAgICAgICAgZmluaXNoRmlsZXMoKTtcblxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmaW5pc2hGaWxlcygpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gZmluaXNoRmlsZXMoKXtcblxuICAgICAgICBpZiAoaGFzRmluaXNoZWRGaWxlcyB8fCBPYmplY3QudmFsdWVzKGZpbGVzRmV0Y2hlZCkuaW5jbHVkZXMoZmFsc2UpKSByZXR1cm47XG4gICAgICAgIGhhc0ZpbmlzaGVkRmlsZXMgPSB0cnVlO1xuXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ0ZpbmlzaGVkIGZldGNoaW5nIGZpbGVzJyk7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ0ZpbGVzOiAnLCBbLi4uY2Fub25pY2FsRmlsZXMuZmlsZXMsIC4uLmhpZGRlbkZpbGVzXSk7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ1VwZGF0ZXM6ICcsIGNhbm9uaWNhbEZpbGVzLmZpbGVfdXBkYXRlcyk7XG5cbiAgICAgICAgcHJvY2Vzc0ZpbGVzKFsuLi5jYW5vbmljYWxGaWxlcy5maWxlcywgLi4uaGlkZGVuRmlsZXNdLCBjYW5vbmljYWxGaWxlcy5maWxlX3VwZGF0ZXMpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHByb2Nlc3NGaWxlcyhmaWxlczogcmF3SW5mby5JRmlsZVtdLCB1cGRhdGVzOiByYXdJbmZvLklVcGRhdGVbXSk6IHZvaWQge1xuICAgICAgICBmaWxlc0J5SWQgPSBPYmplY3QuZnJvbUVudHJpZXMoZmlsZXMubWFwKGZpbGUgPT4gW2ZpbGUuZmlsZV9pZCwgZmlsZV0pKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHVwZGF0ZSBvZiB1cGRhdGVzKSB7XG4gICAgICAgICAgICBhZGRVcGRhdGUodXBkYXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ0ZpbGUgVHJlZXM6JywgZmlsZVRyZWVzKTtcbiAgICAgICAgY29uc29sZS5kZWJ1ZygnRmlsZSBUcmVlcyBieSBJRDonLCBmaWxlVHJlZXNCeUlEKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBhZGRVcGRhdGUodXBkYXRlOiByYXdJbmZvLklVcGRhdGUpIHtcbiAgICAgICAgY29uc3Qgb2xkRmlsZSA9IGZpbGVzQnlJZFt1cGRhdGUub2xkX2ZpbGVfaWRdO1xuICAgICAgICBpZiAoIW9sZEZpbGUpIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgT0xEIGZpbGUgJHt1cGRhdGUub2xkX2ZpbGVfaWR9IGZvciB1cGRhdGVcXG4ke0pTT04uc3RyaW5naWZ5KHVwZGF0ZSwgdW5kZWZpbmVkLCA0KX1gKTtcblxuICAgICAgICBjb25zdCBuZXdGaWxlID0gZmlsZXNCeUlkW3VwZGF0ZS5uZXdfZmlsZV9pZF07XG4gICAgICAgIGlmICghbmV3RmlsZSkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBORVcgZmlsZSAke3VwZGF0ZS5uZXdfZmlsZV9pZH0gZm9yIHVwZGF0ZVxcbiR7SlNPTi5zdHJpbmdpZnkodXBkYXRlLCB1bmRlZmluZWQsIDQpfWApO1xuXG4gICAgICAgIGNvbnN0IG9sZEZpbGVUcmVlID0gZmlsZVRyZWVzQnlJRFtvbGRGaWxlLmZpbGVfaWRdID8/IHtmaWxlSW5mbzogb2xkRmlsZSwgb2xkRmlsZTogbnVsbH07XG4gICAgICAgIHJlbW92ZU9sZEZpbGVUcmVlKHVwZGF0ZSk7XG5cbiAgICAgICAgY29uc3QgbmV3RmlsZVRyZWUgPSB7ZmlsZUluZm86IG5ld0ZpbGUsIG9sZEZpbGU6IG9sZEZpbGVUcmVlfTtcbiAgICAgICAgZmlsZVRyZWVzLnB1c2gobmV3RmlsZVRyZWUpO1xuXG4gICAgICAgIC8vIFVwZGF0ZSBmaWxlIHRyZWUgYnkgSURcbiAgICAgICAgZmlsZVRyZWVzQnlJRFtuZXdGaWxlLmZpbGVfaWRdID0gbmV3RmlsZVRyZWU7XG5cbiAgICAgICAgLy9pICs9IDE7XG4gICAgICAgIC8vYWZzLndyaXRlRmlsZShgb3V0cHV0L2ZpbGVUcmVlcyR7aX0uanNvbmAsIEpTT04uc3RyaW5naWZ5KGZpbGVUcmVlcywgdW5kZWZpbmVkLCA0KSwge2VuY29kaW5nOiAndXRmLTgnfSk7XG4gICAgICAgIC8vYWZzLndyaXRlRmlsZShgb3V0cHV0L2ZpbGVUcmVlc19ieUlEJHtpfS5qc29uYCwgSlNPTi5zdHJpbmdpZnkoZmlsZVRyZWVzQnlJRCwgdW5kZWZpbmVkLCA0KSwge2VuY29kaW5nOiAndXRmLTgnfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVtb3ZlT2xkRmlsZVRyZWUodXBkYXRlOiByYXdJbmZvLklVcGRhdGUpe1xuICAgICAgICBjb25zdCBvbGRGaWxlID0gZmlsZXNCeUlkW3VwZGF0ZS5vbGRfZmlsZV9pZF07XG4gICAgICAgIGlmICghb2xkRmlsZSkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBPTEQgZmlsZSAke3VwZGF0ZS5vbGRfZmlsZV9pZH0gZm9yIHVwZGF0ZVxcbiR7SlNPTi5zdHJpbmdpZnkodXBkYXRlLCB1bmRlZmluZWQsIDQpfWApO1xuXG4gICAgICAgIGNvbnN0IG9sZEZpbGVUcmVlID0gZmlsZVRyZWVzQnlJRFtvbGRGaWxlLmZpbGVfaWRdID8/IHtmaWxlSW5mbzogb2xkRmlsZSwgb2xkRmlsZTogbnVsbH07XG5cbiAgICAgICAgY29uc3Qgb2xkRmlsZVRyZWVJbmRleCA9IGZpbGVUcmVlcy5pbmRleE9mKG9sZEZpbGVUcmVlKTtcbiAgICAgICAgY29uc29sZS5sb2cob2xkRmlsZVRyZWVJbmRleCk7XG5cbiAgICAgICAgaWYgKG9sZEZpbGVUcmVlSW5kZXggPCAwKSByZXR1cm47XG5cbiAgICAgICAgLy8gUmVwbGFjZSBvbGQgZmlsZSB0cmVlXG4gICAgICAgIGZpbGVUcmVlcy5zcGxpY2Uob2xkRmlsZVRyZWVJbmRleCwgMSk7XG4gICAgICAgIHJlbW92ZU9sZEZpbGVUcmVlKHVwZGF0ZSk7XG4gICAgfVxufVxuXG5cblxuXG4vKlxuICogICAgJCQkJCQkJCRcXCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJFxcXG4gKiAgICAkJCAgX19fX198ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCQgfFxuICogICAgJCQgfCAgICAgICQkXFwgICAkJFxcICAkJCQkJCRcXCAgICQkJCQkJFxcICAgJCQkJCQkXFwgICQkJCQkJFxcICAgICQkJCQkJCRcXFxuICogICAgJCQkJCRcXCAgICBcXCQkXFwgJCQgIHwkJCAgX18kJFxcICQkICBfXyQkXFwgJCQgIF9fJCRcXCBcXF8kJCAgX3wgICQkICBfX19fX3xcbiAqICAgICQkICBfX3wgICAgXFwkJCQkICAvICQkIC8gICQkIHwkJCAvICAkJCB8JCQgfCAgXFxfX3wgICQkIHwgICAgXFwkJCQkJCRcXFxuICogICAgJCQgfCAgICAgICAkJCAgJCQ8ICAkJCB8ICAkJCB8JCQgfCAgJCQgfCQkIHwgICAgICAgICQkIHwkJFxcICBcXF9fX18kJFxcXG4gKiAgICAkJCQkJCQkJFxcICQkICAvXFwkJFxcICQkJCQkJCQgIHxcXCQkJCQkJCAgfCQkIHwgICAgICAgIFxcJCQkJCAgfCQkJCQkJCQgIHxcbiAqICAgIFxcX19fX19fX198XFxfXy8gIFxcX198JCQgIF9fX18vICBcXF9fX19fXy8gXFxfX3wgICAgICAgICBcXF9fX18vIFxcX19fX19fXy9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgJCQgfFxuICogICAgICAgICAgICAgICAgICAgICAgICAkJCB8XG4gKiAgICAgICAgICAgICAgICAgICAgICAgIFxcX198XG4gKi9cblxuLyoqIFRvcCByb3cgb2YgdGhlIENTViAqL1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGkxOG4tdGV4dC9uby1lblxuY29uc3QgY3N2SGVhZGVyID0gJ0RhdGVcXHREb3dubG9hZHNcXHRQYWdlIFZpZXdzXFx0RW5kb3JzZW1lbnRzXFx0RGF5cyBTaW5jZSBMYXN0IFVwbG9hZCc7XG5cbmZ1bmN0aW9uIGdldEFycmF5T2ZEYXRhRGF0YShtYXBwZWREYXRlVG9EYXRhOiBJTW9kU3RhdHMpOiBNYXA8c3RyaW5nLCBJRGF0ZURhdGE+IHtcbiAgICByZXR1cm4gbmV3IE1hcChcbiAgICAgICAgT2JqZWN0LmVudHJpZXMobWFwcGVkRGF0ZVRvRGF0YSkuc29ydCgoYSwgYikgPT5cbiAgICAgICAgICAgIC0gKCAoYVsxXT8uZGF0ZU9iaj8uZ2V0VGltZSgpID8/IDApIC0gKGJbMV0/LmRhdGVPYmo/LmdldFRpbWUoKSA/PyAwKSApXG4gICAgICAgIClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBnZXRDU1YobWFwcGVkRGF0ZVRvRGF0YTogSU1vZFN0YXRzKSA6IHN0cmluZ1tdIHtcblxuICAgIGNvbnN0IGRhdGFTb3J0ZWRCeURlc2NlbmRpbmdEYXRlID0gZ2V0QXJyYXlPZkRhdGFEYXRhKG1hcHBlZERhdGVUb0RhdGEpO1xuXG4gICAgLyoqIGRhdGFTb3J0ZWRCeURlc2NlbmRpbmdEYXRlIGluIHRoZSBmb3JtIG9mIENTViBkYXRhIHN0cmluZ3MgKi9cbiAgICBjb25zdCBjc3ZEYXRhID0gWy4uLmRhdGFTb3J0ZWRCeURlc2NlbmRpbmdEYXRlXVxuICAgICAgICAvLyBNYXAgdG8gQ1NWIHN0cmluZ1xuICAgICAgICAubWFwKChbLCB0aGlzRGF0ZURhdGFdKSA9PiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGkxOG4tdGV4dC9uby1lblxuICAgICAgICAgICAgYCR7dGhpc0RhdGVEYXRhLmRhdGVPYmo/LnRvTG9jYWxlRGF0ZVN0cmluZygpfVxcdCR7dGhpc0RhdGVEYXRhLmRvd25sb2FkcyA/PyAwfVxcdCR7dGhpc0RhdGVEYXRhLnBhZ2VWaWV3cyA/PyAwfVxcdCR7dGhpc0RhdGVEYXRhLmVuZG9yc2VtZW50cyA/PyAwfVxcdCR7dGhpc0RhdGVEYXRhLmRheXNTaW5jZUxhc3RVcGxvYWQgPz8gJ05vIFVwbG9hZCBZZXQnfWBcbiAgICAgICAgKTtcblxuICAgIGNvbnNvbGUuZGVidWcoJ0NTViBkYXRhOicsIGNzdkRhdGEpO1xuICAgIHJldHVybiBjc3ZEYXRhO1xuXG59XG4iXX0=