import{getInputValue as he}from"../../universal.js";const je="https://api.nexusmods.com/v1/games";window.statsScraper={async scrapeStats(){!function(e){function t(e){const t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate())}const s={};for(const[o,a]of Object.entries(e.endorsements.endorsements)){const e=t(o),n=e.getTime();s[n]||(s[n]={}),s[n].endorsements=a,s[n].dateObj=e}for(const[o,a]of Object.entries(e.dlAndViews.mod_daily_counts)){const e=t(o),n=e.getTime();s[n]||(s[n]={}),s[n].downloads=a,s[n].dateObj=e}for(const[o,a]of Object.entries(e.dlAndViews.mod_page_views)){const e=t(o),n=e.getTime();s[n]||(s[n]={}),s[n].pageViews=a,s[n].dateObj=e}const n={};for(const o of e.fileUploads.message.releases){const e=t(1e3*o.date).getTime();n[e]||(n[e]=[]),o.date=e,n[e].push(o)}Object.fromEntries(Object.entries(n).sort()),console.debug("Fetched releases:",n);for(const[o]of Object.entries(s)){const e=parseInt(o),t=parseInt(Object.keys(n).filter(t=>parseInt(t)<=e).sort().pop()??"-1"),a=-1===t?null:Math.round((e-t)/864e5);s[e].daysSinceLastUpload=a}Object.values(s)}(await async function(){const e=parseInt(he(document.getElementById("statsScraper_modID"))),t=parseInt(he(document.getElementById("statsScraper_gameID"))),s=await fetch(`${je}/${t}/mods/${e}.json`,De()).then(e=>e.json()),n=fetch(`https://nexus-stats.fra1.cdn.digitaloceanspaces.com/mods/${s.uid}/daily-endorsements.json`,De()).then(e=>e.json()),o=fetch(`https://staticstats.nexusmods.com/mod_monthly_stats/${s.game_id}/${e}.json`,De()).then(e=>e.json()),a=fetch(`https://www.nexusmods.com/Core/Libs/Common/Widgets/Graph?GetModReleases&game_id=${s.game_id}&mod_id=${e}&startdate=0&enddate=${Date.now()}`,De()).then(e=>e.json()),[r,d,c]=await Promise.all([n,o,a]);return console.debug("Fetched stats: ",{topLevel:s,endorsements:r,dlAndViews:d,fileUploads:c}),{topLevel:s,endorsements:r,dlAndViews:d,fileUploads:c}}())},async setIDsFromURL(e){e||(e=he(document.getElementById("statsScraper_extractURL")));const t=e.match(/.*?\bnexusmods\.com\/(\w+)\/mods\/(?:.*?\/)*?(\d+)\/?(\?.*|#.*|[^\w]*)$/);if(!t)throw new Error("Invalid URL");const s=document.getElementById("statsScraper_modID"),n=document.getElementById("statsScraper_gameID");if(!s||!n)throw new Error("Could not find modID or gameID input elements");const o=parseInt(t[2]??""),a=t[1]??"",r=await fetch(`${je}/${a}.json`,De()).then(e=>e.json()).then(e=>e.game_id);s.value=o.toString(),n.value=r.toString()}};let Ie=null,_e=!1;function De(e,t="get"){if(e||(e=Ie||(Ie=he(document.getElementById("statsScraper_apiKey"))||null,_e||(_e=!0,requestAnimationFrame(()=>requestAnimationFrame(()=>{_e=!1,Ie=null}))),Ie)),!e)throw new Error("No API key provided!");const s={cache:"no-cache",method:t,referrerPolicy:"unsafe-url",credentials:"omit",headers:{apiKey:e,accept:"application/json","user-agent":"BellCubeDev/NexusMods-Mod-Stats-Scraper",origin:window.location.origin}};return console.log("Returning request init:",s),s}
//# sourceMappingURL=https://raw.githubusercontent.com/BellCubeDev/site-testing-unstable/deployment/tools/nexus-stats-scraper/nexus-stats-scraper.js.map